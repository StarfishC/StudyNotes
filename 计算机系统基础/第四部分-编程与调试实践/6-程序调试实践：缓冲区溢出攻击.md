# 程序调试实践：缓冲区溢出攻击实验

**[:question: 概述](#概述)**  
**[:question: 目标程序与辅助工具](#目标程序与辅助工具)**  
**[:question: Level 0](#level-0)**  
**[:question: Level 1 及课后实验](#level-1及课后实验)**

## 概述

### 实验目的

假设对 IA-32 函数调用规则（约定）和栈组织结构的具体理解

### 实验环境

OS: Arch Linux on Windows 10 x86_64  
Kernel: 5.15.153.1-microsoft-standard-WSL2  
C 语言/汇编语言

### 实验内容

对一个可执行目标程序“bufbomb”实施一系列缓冲区溢出攻击  
设法通过早成目标程序中的缓冲区溢出（例如将特定字节序列插入到基本不应出现的内存位置），改变目标程序的运行内存映像，达到实验要求的目标

### 实验任务

Level0：smoke（使目标程序调用 smoke 函数）  
Level1：fizz（使目标程序使用特定参数调用 fizz 函数）  
Level2：bang（使目标程序调用 bang 函数并修改全局变量）  
Level3：rumble（使目标程序调用 rumble 函数并传递合适的调用参数）  
Level4：boom（包含栈帧修复的无感攻击，并传递有效返回值）  
Level5：kaboom（实现栈帧地址随机变化下的有效攻击）

### 任务说明

每级实验需根据任务目标，设计、构造 1 个攻击字符，对目标程序实施缓冲区溢出攻击，完成相应目标

### 实验数据

下载本实验相关的 tar 文件，[下载链接](https://cs.nju.edu.cn/sufeng/course/mooc/0809NJU064_buflab.tar)

“tar xvf 0809NJU064_buflab.tar”将其中包含的文件提取到当前目录中。该 tar 文件中包含如下实验所需文件：

- bufbomb：实验需要攻击的目标 buffer bomb 程序
- makecookie：该程序基于命令行参数给出的 ID，产生一个唯一的由 8 个 16 进制数
  字组成的字节序列（例如 0x1005b2b7），称为“cookie”，用作实验中可能需要置
  入栈中的数据之一
- hex2raw：字符串格式转换程序

## 目标程序与辅助工具

### 目标程序`bufbomb`

bufbomb 程序接受下列命令行参数：

- -u userid：以给定的用户 ID “usrid”（例如学号）运行程序。每次在运行程序时均应指定该参数，因为 bufbomb 程序将基于 userid 决定内部使用的一个 cookie 值（同 makecookie 程序的输出），而 bufbomb 程序内部的一些关键的栈地址取决于 userid 所对应的 cookie 值
- n：以“Nitro”模式运行，专用于最后一个实验级别 kaboom

#### 实验任务

精心设计输入给目标程序 bufbomb 的字符串（称为攻击字符串），通过造成缓冲区溢出来完成一些指定的任务

#### 实验关键

确定将栈中的哪些数据条目作为攻击目标，以设计攻击字符串来改写其内容

### 辅助程序`hex2raw`

#### 存在问题

攻击字符串可能包含地址、指令等不属于 ASCII 可打印字符集合（最高位为 0）的字节值，无法直接编辑输入

#### 解决方法

1. 将攻击字符串中每一字节按其高、低 4 位的取值，表示为两个十六进制数字，并在每对十六进制数字之间用空格、换行等空白字符分隔
2. 使用程序`hex2raw`将上述十六进制数字对序列转换为对应的攻击字符串，`hex2raw`程序从标准输入接收数字序列，转换后送往标准输出

#### 程序说明

`hex2raw`程序支持在输入字符串中，包含 C 语言风格的块注释，在不影响攻击字符串的解释与使用的同时，增加了转换前的攻击字符串的可读性

### 使用攻击字符串

- 将十六进制数字对序列形式的攻击字符串包含于一个文本文件（例如：level.txt）中
- 使用`hex2raw`程序和管道操作符，将文件内容转换为对应的实际攻击字符串，再输入`bufbomb`目标程序执行攻击 `cat level.txt | ./hex2raw | ./bufbomb -u`

### 辅助程序`makecookie`

`makecookie`：用于基于命令行上指定的userid选项，生成对应的cookie数据并送往标准输出  
`cookie`：一个可表示为8个十六进制数字的32位整数，对每个userid是唯一的

例如：`./makecookie 123456789` 输出 `0x25e1304b`
