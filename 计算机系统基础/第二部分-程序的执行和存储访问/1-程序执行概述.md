# 程序执行概述

**概览：**

**[:question: 程序和指令的关系](#程序和指令的关系)**  
**[:question: 一条指令的执行过程](#一条指令的执行过程)**  
**[:question: CPU 的基本功能与结构](#cpu-的基本功能与结构)**

## 程序和指令的关系

- 程序和指令的关系
  - 程序由一条条指令组成，指令按顺序存放在内存连续单元
- 程序的执行：周而复始地执行一条一条指令
  - 正常情况下，指令按其存放顺序执行
  - 遇到需要改变程序执行流程时，用相应的转移指令（包括无条件转移指令、条件转移指令、调用指令和返回指令等）来改变程序执行流程
- 程序的执行流的控制
- 将要执行的指令所在的存储单元的地址由程序计数器 PC 给出，通过改变 PC 的值来控制执行顺序
- 指令周期：CPU 取出并执行一条指令的时间

## 一条指令的执行过程

汇编和十六进制都是为了方便记忆和阅读的代码，在内存中存放的指令实际上是机器代码（0/1 序列）

```s
08048394 <add>:
 8048394:   55          push %ebp
 8048395:   89 e5       mov %esp, %ebp
 8048397:   8b 45 0c    mov 0xc(%ebp), %eax
 804839a:   03 45 08    add 0x8(%ebp), %eax
 804839d:   5d          pop %ebp
 804839e:   c3          ret
```

程序执行需要解决的问题：

1. 如何判定每条指令有多长？
2. 如何判定操作类型、寄存器编号、立即数等？
3. 如何区分第 2 行和第 3 行 mov 指令的不同？
4. 如何确定操作数是在寄存器中还是存储器中？
5. 一条指令执行结束后如何正确读取到下一条指令

对于上面的 add 函数

- 指令按顺序存放在 0x8048394 开始的存储空间
- 各指令长度可能不同，如 push、pop 和 ret 指令各占一个字节，第 2 行 mov 指令占两个字节，第 3 行 mov 指令和第 4 行 add 指令各占 3 字节
- 各指令对应的 0/1 序列含义有不同的规定，如“push %ebp”指令为 01010101B，其中 01010 为 push 的操作码，101 为 EBP 的编号；“pop %ebp”为 01011101B，其中 01011 为 pop 指令的操作码

### 机器指令的执行过程

1. 取指令  
   从 PC 所指单元取出指令送指令寄存器 IR  
   如 add 函数，开始 PC（IA-32 的 EIP）中存放的是 0x8048394，CPU 根据 PC 取指令送 IR，每次总是取最长指令字节数，假定最长指令是 4 个字节，即 IR 是 32 位，此时取到 IR 中的是 55 89 e5 8b
2. 指令译码  
   不同指令其功能不同，因而需要不同的操作控制信号  
   CPU 根据不同操作码译出不同控制信号。对于上述取到 IR 中的 55 89 e5 8b 时，可根据高 5 位 01010 译码得到 push 指令的控制信号
3. 源操作数地址计算并取操作数  
   根据寻址方式确定源操作数地址计算方式，若是存储器数据，则需一次或多次访存  
   若为间接寻址或两操作数都在存储器的双目运算，则需多次访存  
   若是寄存器数据，则直接从寄存器取数
4. 执行数据操作  
   在 ALU 或加法器等运算部件中对取出的源操作数进行运算
5. 目的操作数地址计算并存结果  
   根据寻址方式确定目的操作数地址计算方式，若是存储器数据，则需一次或多次访存  
   若是寄存器数据，则在进行数据操作时直接存结果到寄存器
6. 指令地址计算并将其送 PC（PC+“1”）  
   “1”：指一条指令的长度，定长指令字每次都一样；变长指令字每次可能不同  
   顺序执行时，PC 加上当前指令的长度；遇到转移类指令时，则需要根据条件码、操作码和寻址方式等确定下条指令地址  
   如：add 的第一条指令使用到的仅是 55，所以 PC+“1”的“1”是一个字节，即下一条指令的地址是 0x8048395

指令执行过程中查询各种异常情况，并在发生异常时转异常处理  
指令结束时查询中断请求，并在发现中断请求时响应中断

## CPU 的基本功能与结构

- CPU 的基本功能就是周而复始地执行指令，CPU 运行程序的过程就是执行一条一条指令的过程
- CPU 最基本的部分是数据通路和控制单元
  - 数据通路（data path）中包含组合逻辑元件和存储信息的状态元件  
    组合逻辑（如加法器、ALU、扩展器、多路选择器以及状态元件的读操作逻辑等）用于对数据进行处理
  - 控制单元（control unit）：对取出的指令进行译码，与指令执行得到的条件标志或当前机器状态、时序信号等组合，生成对数据通路进行控制的控制信号，如读信号 Rd、写信号 Wr、ALU 控制信号 ALUctr 等
